<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Color Noise</title>

  <!-- iOS icon + basic PWA bits -->
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="theme-color" content="#0b0f18">

  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0; min-height: 100vh; display: grid; place-items: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(120,120,255,.22), transparent 60%),
                  radial-gradient(1000px 700px at 80% 90%, rgba(0,255,200,.12), transparent 60%),
                  linear-gradient(135deg, #0b0f18, #070a10);
      color: #e8eefc;
    }
    .card {
      width: min(980px, 92vw);
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 22px;
      padding: 28px;
      box-shadow: 0 20px 80px rgba(0,0,0,0.45);
      backdrop-filter: blur(12px);
    }
    h1 { margin: 0 0 6px; font-size: 44px; letter-spacing: -0.02em; }
    .sub { margin: 0 0 18px; color: rgba(232,238,252,0.78); font-size: 18px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .btn {
      cursor: pointer;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      color: #e8eefc;
      font-weight: 650;
      user-select: none;
    }
    .btn:hover { background: rgba(255,255,255,0.12); }
    .btn.active { outline: 2px solid rgba(120,180,255,0.9); }
    .panel {
      margin-top: 18px;
      padding: 18px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 18px;
      align-items: center;
    }
    .timerGrid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 12px;
    }
    .timerBox {
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 14px;
      display: grid;
      grid-template-columns: auto 40px auto 40px;
      align-items: center;
      gap: 10px;
    }
    .label { color: rgba(232,238,252,0.75); font-size: 18px; }
    .num { font-size: 22px; font-weight: 750; text-align: center; }
    .square {
      width: 40px; height: 40px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.12);
      color: #fff;
      font-size: 22px; font-weight: 800;
      display: grid; place-items: center;
      cursor: pointer; user-select: none;
    }
    .square:active { transform: scale(0.98); }
    .statusLine { margin-top: 12px; color: rgba(232,238,252,0.78); font-size: 16px; line-height: 1.4; }
    .small { margin-top: 10px; color: rgba(232,238,252,0.7); font-size: 14px; }
    .pill {
      display: inline-block; padding: 4px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      font-size: 13px; color: rgba(232,238,252,0.78);
      margin-left: 10px;
    }
    audio { width: 100%; margin-top: 12px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Color Noise <span class="pill">Above Average Joe • v1.0</span></h1>
    <p class="sub">Tap a noise to play. Designed to keep playing on iOS during screen lock.</p>

    <div class="row" id="buttons"></div>

    <audio id="player" controls playsinline preload="auto"></audio>

    <div class="panel">
      <div>
        <div class="label">Sleep timer</div>
        <div class="num" id="timerLabel">Off</div>

        <div class="timerGrid">
          <div class="timerBox">
            <div class="label">Hours</div>
            <div class="square" id="hMinus">−</div>
            <div class="num" id="hours">0</div>
            <div class="square" id="hPlus">+</div>
          </div>

          <div class="timerBox">
            <div class="label">Minutes (15m)</div>
            <div class="square" id="mMinus">−</div>
            <div class="num" id="mins">0</div>
            <div class="square" id="mPlus">+</div>
          </div>
        </div>

        <div class="statusLine" id="status">
          Tip: iPhone requires one tap to start audio. After it starts, lock the screen and it should continue.
        </div>
        <div class="small" id="debug"></div>
      </div>

      <button class="btn" id="toggleTimer">Start timer</button>
    </div>
  </div>

<script>
(() => {
  // These are the 1-hour MP3 sources you confirmed work on iOS + Mac.
  const SOURCES = [
    {
      key: "pink",
      label: "Pink (1h)",
      url: "https://archive.org/download/1-hour-pink-noise-quieter-version-2-128/1%20hour%20pink%20noise%20%28quieter%20version%202%29%20128.mp3"
    },
    {
      key: "brown",
      label: "Brown (1h)",
      url: "https://archive.org/download/onlymp-3.to-1-hour-brown-noise-for-focus-sleep-and-comfort-no-music-hjmn-ifd-6-lcg-192k-1707397200/onlymp3.to%20-%201%20Hour%20BROWN%20NOISE%20for%20FOCUS%20SLEEP%20AND%20COMFORT%20no%20music%20-HJMnIfd6Lcg-192k-1707397200.mp3"
    },
    {
      key: "white",
      label: "White-ish (1h)",
      url: "https://archive.org/download/24-hours-lectrofan-sound-and-white-noise-river-128/1%20hour%20lectrofan%20sound%20and%20white%20noise%20river%20128.mp3"
    }
  ];

  const player = document.getElementById("player");
  const buttons = document.getElementById("buttons");
  const status = document.getElementById("status");
  const debug = document.getElementById("debug");

  let currentKey = null;

  function setActive(key) {
    [...buttons.querySelectorAll(".btn")].forEach(b => b.classList.toggle("active", b.dataset.key === key));
  }

  async function playSource(item) {
    try {
      currentKey = item.key;
      setActive(currentKey);

      player.pause();
      player.removeAttribute("src");
      player.load();

      player.src = item.url;
      player.preload = "auto";

      // small delay helps some Safari builds
      await new Promise(r => setTimeout(r, 50));

      await player.play();
      status.textContent = `Playing: ${item.label}`;
    } catch (e) {
      status.innerHTML = `Play failed: ${e?.name || "Error"} ${e?.message ? ("— " + e.message) : ""}`;
    }
  }

  SOURCES.forEach(item => {
    const b = document.createElement("div");
    b.className = "btn";
    b.textContent = item.label;
    b.dataset.key = item.key;
    b.addEventListener("click", () => playSource(item));
    buttons.appendChild(b);
  });

  // --- Sleep timer ---
  const hoursEl = document.getElementById("hours");
  const minsEl = document.getElementById("mins");
  const timerLabel = document.getElementById("timerLabel");
  const toggleTimerBtn = document.getElementById("toggleTimer");

  let hours = 0;
  let mins = 0; // 0,15,30,45
  let timerId = null;
  let endAt = null;
  let tickId = null;

  function clamp() {
    hours = Math.max(0, Math.min(23, hours));
    mins = Math.max(0, Math.min(45, mins));
  }

  function render() {
    hoursEl.textContent = String(hours);
    minsEl.textContent = String(mins);
    if (!endAt) timerLabel.textContent = "Off";
  }

  function totalMs() {
    return (hours * 60 + mins) * 60 * 1000;
  }

  function stopTimer() {
    if (timerId) clearTimeout(timerId);
    if (tickId) clearInterval(tickId);
    timerId = null;
    tickId = null;
    endAt = null;
    toggleTimerBtn.textContent = "Start timer";
    timerLabel.textContent = "Off";
    debug.textContent = "";
  }

  function startTimer() {
    const ms = totalMs();
    if (ms <= 0) return;

    endAt = Date.now() + ms;
    toggleTimerBtn.textContent = "Stop timer";

    timerId = setTimeout(() => {
      player.pause();
      status.textContent = "Timer finished: playback stopped.";
      stopTimer();
    }, ms);

    tickId = setInterval(() => {
      const left = Math.max(0, endAt - Date.now());
      const totalM = Math.ceil(left / 60000);
      const h = Math.floor(totalM / 60);
      const m = totalM % 60;
      timerLabel.textContent = `${h}h ${m}m`;
      debug.textContent = `Time remaining: ${h}h ${m}m`;
      if (left <= 0) stopTimer();
    }, 1000);
  }

  toggleTimerBtn.addEventListener("click", () => {
    if (timerId) stopTimer();
    else startTimer();
  });

  document.getElementById("hMinus").onclick = () => { hours--; clamp(); render(); };
  document.getElementById("hPlus").onclick  = () => { hours++; clamp(); render(); };
  document.getElementById("mMinus").onclick = () => { mins -= 15; clamp(); render(); };
  document.getElementById("mPlus").onclick  = () => { mins += 15; clamp(); render(); };

  render();
})();
</script>
</body>
</html>
