<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ColorNoise v1.6.2</title>

  <!-- Cache control -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b0f18">

  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0; 
      min-height: 100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(120,120,255,.22), transparent 60%),
                  radial-gradient(1000px 700px at 80% 90%, rgba(0,255,200,.12), transparent 60%),
                  linear-gradient(135deg, #0b0f18, #070a10);
      background-attachment: fixed;
      color: #e8eefc;
    }
    
    /* Fixed header with player and timer */
    .fixedHeader {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: rgba(11, 15, 24, 0.98);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 12px 16px;
    }
    
    .headerTop {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .headerLeft {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .logo {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    .logo a { color: inherit; text-decoration: none; }
    .version {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 6px;
      background: rgba(255,255,255,0.1);
      color: rgba(232,238,252,0.7);
      margin-left: 6px;
    }
    .byline {
      font-size: 11px;
      color: rgba(232,238,252,0.6);
    }
    .sourceStatus {
      font-size: 11px;
      color: rgba(232,238,252,0.6);
    }
    .sourceStatus .dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 4px;
      vertical-align: middle;
    }
    .sourceStatus .dot.up { background: #2ecc71; box-shadow: 0 0 4px #2ecc71; }
    .sourceStatus .dot.down { background: #e74c3c; box-shadow: 0 0 4px #e74c3c; }
    .sourceStatus .dot.checking { background: #f39c12; box-shadow: 0 0 4px #f39c12; }
    
    /* Compact player */
    .playerRow {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .nowPlaying {
      font-size: 14px;
      color: rgba(232,238,252,0.9);
      font-weight: 600;
    }
    audio {
      width: 100%;
      height: 40px;
    }
    
    /* Compact timer */
    .timerRow {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .timerLabel {
      font-size: 11px;
      color: rgba(232,238,252,0.6);
    }
    .timerDisplay {
      font-size: 16px;
      font-weight: 800;
      font-variant-numeric: tabular-nums;
      min-width: 60px;
    }
    .timerDisplay.off { opacity: 0.4; }
    .timerControls {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .timerBtn {
      width: 28px; height: 28px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 14px;
      font-weight: 700;
      display: grid;
      place-items: center;
      cursor: pointer;
      user-select: none;
    }
    .timerBtn:active { background: rgba(255,255,255,0.2); }
    .timerNum {
      font-size: 14px;
      font-weight: 700;
      min-width: 20px;
      text-align: center;
    }
    .timerStartBtn {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: #e8eefc;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      margin-left: auto;
    }
    .timerStartBtn:active { background: rgba(255,255,255,0.2); }
    
    /* Fixed favorites panel - always visible below header */
    .stickyFavorites {
      position: fixed;
      top: 175px; /* below header - will be set by JS */
      left: 0;
      right: 0;
      z-index: 90;
      background: #0b0f18;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 12px 16px;
    }
    .stickyFavorites .sectionTitle {
      margin-top: 0;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .stickyFavorites .grid {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    /* Compact favorite tiles - just clickable buttons */
    .favTile {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.08);
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }
    .favTile:hover {
      background: rgba(255,255,255,0.12);
    }
    .favTile.active {
      background: rgba(120,180,255,0.25);
      border-color: rgba(120,180,255,0.5);
    }
    .favTile .colorDot {
      width: 10px;
      height: 10px;
    }
    .favTile .name {
      font-size: 13px;
      font-weight: 600;
    }
    .favTile .headphoneIcon {
      font-size: 10px;
      opacity: 0.6;
      margin-left: 2px;
    }
    
    /* Scrollable content - padding for fixed header */
    .content {
      padding: 16px;
      padding-top: 190px; /* space for fixed header */
      max-width: 800px;
      margin: 0 auto;
    }
    .content.with-favorites {
      padding-top: 280px; /* extra space when favorites visible */
    }
    
    .sectionTitle {
      font-size: 13px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(232,238,252,0.6);
      margin: 16px 0 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }
    .sectionTitle:first-child { margin-top: 0; }
    .sectionTitle:hover { color: rgba(232,238,252,0.8); }
    .collapseBtn {
      font-size: 12px;
      opacity: 0.6;
      transition: transform 0.2s;
    }
    .sectionTitle.collapsed .collapseBtn {
      transform: rotate(-90deg);
    }
    .sectionNote {
      font-size: 10px;
      font-weight: 400;
      text-transform: none;
      letter-spacing: 0;
      opacity: 0.7;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 10px;
    }
    .grid.collapsed {
      display: none;
    }
    
    .tile {
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.25);
      padding: 12px;
    }
    .tileTop {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .colorDot {
      width: 12px; height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
      box-shadow: 0 0 6px currentColor;
    }
    .name {
      font-size: 15px;
      font-weight: 700;
      flex: 1;
    }
    .favBtn {
      font-size: 16px;
      cursor: pointer;
      opacity: 0.4;
      transition: opacity 0.2s;
    }
    .favBtn:hover, .favBtn.active { opacity: 1; }
    .playBtn {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.08);
      color: #e8eefc;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
    }
    .playBtn:hover { background: rgba(255,255,255,0.12); }
    .playBtn.active {
      background: rgba(120,180,255,0.25);
      border-color: rgba(120,180,255,0.5);
    }
    .desc {
      font-size: 12px;
      color: rgba(232,238,252,0.6);
      margin-top: 6px;
      line-height: 1.4;
    }
    
    .hidden { display: none !important; }
  </style>
</head>

<body>

  <!-- Fixed header with player and timer -->
  <div class="fixedHeader">
    <div class="headerTop">
      <div class="headerLeft">
        <div class="logo">
          <a href="https://en.wikipedia.org/wiki/Colors_of_noise" target="_blank">Color Noise â†—</a>
          <span class="version">v1.6.1</span>
        </div>
        <div class="byline">by AboveAverageJoe</div>
        <div class="sourceStatus" id="sourceStatus">
          <span class="dot checking"></span>Sound engine: initializing...
        </div>
      </div>
    </div>
    
    <div class="playerRow">
      <div class="nowPlaying" id="nowPlayingTrack">Select a sound below</div>
      <audio id="player" controls playsinline preload="auto" loop></audio>
    </div>
    
    <div class="timerRow">
      <div class="timerLabel">Sleep</div>
      <div class="timerDisplay off" id="timerDisplay">0:00</div>
      <div class="timerControls">
        <div class="timerBtn" id="hMinus">âˆ’</div>
        <div class="timerNum" id="hours">0</div>
        <div class="timerLabel">h</div>
        <div class="timerBtn" id="hPlus">+</div>
        <div class="timerBtn" id="mMinus">âˆ’</div>
        <div class="timerNum" id="mins">0</div>
        <div class="timerLabel">m</div>
        <div class="timerBtn" id="mPlus">+</div>
      </div>
      <div class="timerStartBtn" id="toggleTimer">Start</div>
    </div>
  </div>

  <!-- Sticky favorites - outside content for proper sticky behavior -->
  <div id="favoritesSection" class="stickyFavorites hidden">
    <div class="sectionTitle" id="favHeader">
      <span class="collapseBtn">â–¼</span>
      â˜… Favorites
    </div>
    <div class="grid" id="favGrid"></div>
  </div>

  <!-- Scrollable stations -->
  <div class="content">
    <div class="sectionTitle" data-section="core">
      <span class="collapseBtn">â–¼</span>
      Core Colors
    </div>
    <div class="grid" id="coreGrid"></div>
    
    <div class="sectionTitle" data-section="blends">
      <span class="collapseBtn">â–¼</span>
      Nature + Noise Blends
    </div>
    <div class="grid" id="blendsGrid"></div>
    
    <div class="sectionTitle" data-section="binaural">
      <span class="collapseBtn">â–¼</span>
      Binaural Beats
      <span class="sectionNote">ðŸŽ§ headphones required</span>
    </div>
    <div class="grid" id="binauralGrid"></div>
    
    <div class="sectionTitle" data-section="nature">
      <span class="collapseBtn">â–¼</span>
      Nature Sounds
    </div>
    <div class="grid" id="natureGrid"></div>
    
    <div class="sectionTitle" data-section="mechanical">
      <span class="collapseBtn">â–¼</span>
      ðŸš€ Mechanical / Sci-Fi
    </div>
    <div class="grid" id="mechanicalGrid"></div>
  </div>

<script>
(() => {
  const COLORS = {
    white: "#ffffff",
    pink: "#ff69b4",
    brown: "#8b4513",
    blue: "#4a90d9",
    green: "#2ecc71",
    red: "#cd5c5c",
    purple: "#9b59b6",
    orange: "#e67e22",
    gray: "#95a5a6",
    cyan: "#00bcd4"
  };

  const SOURCES_CORE = [
    {
      key: "white",
      name: "White",
      color: COLORS.white,
      desc: "Broad spectrum hiss. Best for masking sudden noises. 1 hour.",
      url: "https://archive.org/download/24-hours-lectrofan-sound-and-white-noise-river-128/1%20hour%20lectrofan%20sound%20and%20white%20noise%20river%20128.mp3"
    },
    {
      key: "pink",
      name: "Pink",
      color: COLORS.pink,
      desc: "Smoother than white. Feels like rainfall. 1 hour.",
      url: "https://archive.org/download/classical-music-mixed-with-pink-noise-for-sleep-and-relax_202105/Soothing%20Deep%20Pink%20Noise%20%201%20Hour.mp3"
    },
    {
      key: "brown",
      name: "Brown",
      color: COLORS.brown,
      desc: "Deep bass-heavy rumble. Very calming. 1 hour.",
      url: "https://archive.org/download/1-hour-brown-noise-and-flowing-water-320/1%20hour%20Brown%20Noise%20and%20Flowing%20River%20flac.mp3"
    },
    {
      key: "blue",
      name: "Blue",
      color: COLORS.blue,
      desc: "Higher frequencies. Masks high-pitched sounds. 1 hour.",
      url: "https://archive.org/download/1-hour-texas-river-rapids-and-deep-blue-noise-320/1%20hour%20texas%20river%20rapids%20and%20deep%20blue%20noise%20320.mp3"
    },
    {
      key: "green_pure",
      name: "Green (Pure)",
      color: COLORS.green,
      desc: "Mid-frequency, nature-like. Stress and anxiety relief. 4 hours.",
      url: "https://archive.org/download/green-noise/Green%20Noise.mp3"
    },
    {
      key: "red",
      name: "Red (Deep Brown)",
      color: COLORS.red,
      desc: "Even deeper than brown. Extremely relaxing. 1 hour.",
      url: "https://archive.org/download/red-noise_202207/red%20noise.mp3"
    }
  ];

  const SOURCES_BLENDS = [
    {
      key: "blue_waterfall",
      name: "Blue + Waterfall",
      color: COLORS.blue,
      desc: "Blue noise with waterfall. 1 hour.",
      url: "https://archive.org/download/clip-waterfall-relaxing-sleep-rem-asmr/1%20hour%20waterfall%20relaxing%20sleep%20blue%20noise%20rem%20asmr%20320.mp3"
    },
    {
      key: "red_waterfall",
      name: "Red + Waterfall",
      color: COLORS.red,
      desc: "Deep red/brown with waterfall. 1 hour.",
      url: "https://archive.org/download/clip-waterfall-relaxing-sleep-rem-asmr/1%20hour%20waterfall%20relaxing%20rem%20red%20noise%20sleep%20320.mp3"
    },
    {
      key: "brown_river",
      name: "Brown + River",
      color: COLORS.brown,
      desc: "Brown noise with peaceful river. 1 hour.",
      url: "https://archive.org/download/24-hours-peaceful-river-and-brown-noise-vbr/1%20hour%20v3%20river%20and%20brown%20noise%20vbr.mp3"
    },
    {
      key: "brown_rain",
      name: "Brown + Rain",
      color: COLORS.brown,
      desc: "Brown noise with rain. 1 hour.",
      url: "https://archive.org/download/red-noise_202207/1-rain%20and%20brown%20noise%20-%20320%20-%201%20hour.mp3"
    },
    {
      key: "brown_stream",
      name: "Brown + Mountain Stream",
      color: COLORS.brown,
      desc: "Brown noise with stream and rain. 1 hour.",
      url: "https://archive.org/download/1-hour-mountain-stream-doubled-and-brown-noise-flac/1%20hour%20mountain%20stream%20-%20rain%20shower%20-%20brown%20noise%20v2%20320.mp3"
    },
    {
      key: "white_roaring",
      name: "White + Roaring Waterfall",
      color: COLORS.white,
      desc: "White noise with powerful waterfall. 10 hours.",
      url: "https://archive.org/download/1-fan-4-1-hour-flac/Roaring%20Waterfall%20White%20Noise%2010%20hours.mp3"
    },
    {
      key: "brown_terraced",
      name: "Brown + Terraced Waterfall",
      color: COLORS.brown,
      desc: "Brown noise with cascading water. 10 hours.",
      url: "https://archive.org/download/1-fan-4-1-hour-flac/10%20hours%20terraced%20waterfall%20brown%20noise%20sound%20128.mp3"
    },
    {
      key: "pink_reading",
      name: "Pink for Focus",
      color: COLORS.pink,
      desc: "Pink noise for reading/concentration. 1 hour.",
      url: "https://archive.org/download/classical-music-mixed-with-pink-noise-for-sleep-and-relax_202105/Pink%20Noise%20Focus%20on%20Reading%20Without%20DistractionsRuido%20RosaLeer%20Sin%20Distracciones.mp3"
    },
    {
      key: "green_stream",
      name: "Green + Stream",
      color: COLORS.green,
      desc: "Mountain stream â€” nature's green noise. 1 hour.",
      url: "https://archive.org/download/10-hours-white-noise-river-mountain-stream-doubled-320/1%20Hour%20Calming%20Mountain%20Stream.mp3"
    },
    {
      key: "alpha_brown",
      name: "Alpha + Brown Noise",
      color: COLORS.purple,
      desc: "Alpha waves blended with brown noise. 1 hour.",
      url: "https://archive.org/download/10-hours-alpha-river-and-brown-noise-flac/1%20hour%20alpha%20river%20and%20brown%20noise%20v1%20flac.mp3"
    },
    {
      key: "turquoise_stream",
      name: "Turquoise Mountain Stream",
      color: COLORS.cyan,
      desc: "Calming turquoise water, mountain stream. 10 hours.",
      url: "https://archive.org/download/10-hours-alpha-river-and-brown-noise-flac/10%20hours%20Calming%20Turquoise%20Water%2C%20Mountain%20Stream%20vbr.mp3"
    },
    {
      key: "hot_tub",
      name: "Hot Tub / Jacuzzi",
      color: COLORS.cyan,
      desc: "Smooth hot tub bubbling. 1 hour.",
      url: "https://archive.org/download/10-hours-alpha-river-and-brown-noise-flac/1%20hour%20smooth%20hot%20tub%20128.mp3"
    }
  ];

  const SOURCES_BINAURAL = [
    {
      key: "alpha_focus",
      name: "Alpha (12 Hz) - Focus",
      color: COLORS.purple,
      desc: "Promotes alert relaxation and focus. Use headphones. 1 hour.",
      url: "https://archive.org/download/RestorativeSleepMusicBinauralBeatsSleepInTheClouds432Hz/Pure%20Alpha%20Waves%20Binaural%20Beats%20%2812%20Hz%29%20%201H.mp3",
      headphones: true
    },
    {
      key: "theta_meditation",
      name: "Theta (4 Hz) - Meditation",
      color: COLORS.purple,
      desc: "Deep meditation and creativity. Use headphones. 1 hour.",
      url: "https://archive.org/download/RestorativeSleepMusicBinauralBeatsSleepInTheClouds432Hz/Pure%20Theta%20Waves%20%284%20Hz%29%20%20Deep%20Meditation%20-%201hr%20Binaural%20Beats.mp3",
      headphones: true
    },
    {
      key: "delta_sleep",
      name: "Delta (0.5 Hz) - Deep Sleep",
      color: COLORS.purple,
      desc: "Deepest relaxation and sleep. Use headphones. 1 hour.",
      url: "https://archive.org/download/RestorativeSleepMusicBinauralBeatsSleepInTheClouds432Hz/Pure%20Delta%20Waves%20%280.5%20Hz%20Binaural%20Beats%29%20%201H.mp3",
      headphones: true
    },
    {
      key: "gamma_40hz",
      name: "Gamma (40 Hz) - Peak Focus",
      color: COLORS.purple,
      desc: "40 Hz gamma for focus, calmness, happiness. Use headphones. 1 hour.",
      url: "https://archive.org/download/study-music-alpha-waves-studying-music-concentration-music-focus-music-for-work-brain-power/Gamma%20Brain%20Waves%20Meditation%2040%20Hz%20frequency%201%20Hr%20Producing%20Focus%20Calmness%20Happiness.mp3",
      headphones: true
    },
    {
      key: "anxiety_relief",
      name: "Anxiety Relief",
      color: COLORS.purple,
      desc: "Release stress, worry, overthinking. Use headphones. 1 hour.",
      url: "https://archive.org/download/study-music-alpha-waves-studying-music-concentration-music-focus-music-for-work-brain-power/Anxiety%20Relief%20%20Release%20Stress%20Worry%20Overthinking%20%20Binaural%20Beats%20%20Meditation%20Music.mp3",
      headphones: true
    },
    {
      key: "stay_awake",
      name: "Stay Awake - Isochronic",
      color: COLORS.purple,
      desc: "Isochronic tones for staying awake and alert. 30 min.",
      url: "https://archive.org/download/study-music-alpha-waves-studying-music-concentration-music-focus-music-for-work-brain-power/Staying%20Awake%20%20Isochronic%20Tones%20%20Brainwave%20Entrainment%20Meditation.mp3",
      headphones: true
    },
    {
      key: "beta_30hz",
      name: "Beta (30 Hz) - Alertness",
      color: COLORS.purple,
      desc: "Pure 30 Hz beta binaural for alertness. Use headphones. 30 min.",
      url: "https://archive.org/download/study-music-alpha-waves-studying-music-concentration-music-focus-music-for-work-brain-power/30%20Hz%20Pure%20BINAURAL%20Beat%20%20BETA%20Waves%2070Hz%20Base%20Frequency%20%20Ondas%20Beta%20100.mp3",
      headphones: true
    },
    {
      key: "deep_alpha_15min",
      name: "Deep Alpha - Quick",
      color: COLORS.purple,
      desc: "Deep alpha binaural meditation. Use headphones. 15 min.",
      url: "https://archive.org/download/study-music-alpha-waves-studying-music-concentration-music-focus-music-for-work-brain-power/Deep%20Alpha%20Binaural%20Beats%2015%20min%20Meditation.mp3",
      headphones: true
    },
    {
      key: "theta_432hz",
      name: "Theta + 432 Hz - DMT",
      color: COLORS.purple,
      desc: "Theta brainwaves with 432 Hz and 60 Hz. Use headphones. 1 hour.",
      url: "https://archive.org/download/study-music-alpha-waves-studying-music-concentration-music-focus-music-for-work-brain-power/Theta%20Brainwaves%20%20432hz%20%208hz%20%2060hz%20%20%20Pineal%20Gland%20DMT%20Music.mp3",
      headphones: true
    }
  ];

  const SOURCES_NATURE = [
    {
      key: "thunder_beach",
      name: "Thunder + Rain + Beach",
      color: COLORS.gray,
      desc: "Very low rumbling thunder with rain and waves. 8 hours.",
      url: "https://archive.org/download/relaxingsounds/Thunder%201%208h%20VeryLowRumbling%2CRain%2CWaves-Beach.mp3"
    },
    {
      key: "ocean_night",
      name: "Ocean Waves (Night)",
      color: COLORS.blue,
      desc: "Beach waves from sunset into night. 10 hours.",
      url: "https://archive.org/download/relaxingsounds/Waves%201%2010h%20Beach-Sunset%20into%20Night.mp3"
    },
    {
      key: "rain_medium",
      name: "Rain (Medium)",
      color: COLORS.gray,
      desc: "Medium rain with low gentle thunder. 10 hours.",
      url: "https://archive.org/download/relaxingsounds/Rain%202%20%28Med.%2B%29%2010h%20LowGentleThunder%2C%20Downpour.mp3"
    },
    {
      key: "campfire_crickets",
      name: "Campfire + Crickets",
      color: COLORS.orange,
      desc: "Crackling campfire with crickets and gentle water. 10 hours.",
      url: "https://archive.org/download/relaxingsounds/FIRE%201%2010h%20CracklingCampfire%2CCrickets%2CRainOrRiver-Night.mp3"
    },
    {
      key: "box_fan",
      name: "Box Fan",
      color: COLORS.white,
      desc: "Strong box fan. Classic sleep sound. 10 hours.",
      url: "https://archive.org/download/relaxingsounds/FAN%201%2010h%20Strong%20Box%20Fan.mp3"
    },
    {
      key: "rain_tent",
      name: "Rain on Tent Canvas",
      color: COLORS.gray,
      desc: "Light rain on tent canvas. Medium/gentle, no thunder. 10 hours.",
      url: "https://archive.org/download/relaxingsounds/Rain%206%20%28Light%29%2010h%20on%20Tent%20Canvas%2C%28MediumGentle%29-no%20thunder.mp3"
    },
    {
      key: "oscillating_fan",
      name: "Oscillating Fan",
      color: COLORS.white,
      desc: "Gentle oscillating fan. 10 hours.",
      url: "https://archive.org/download/relaxingsounds/FAN%202%2010h%20Gentle%2COscillating%20Fan.mp3"
    },
    {
      key: "rainforest",
      name: "Rainforest",
      color: COLORS.green,
      desc: "Bubbling river, falls, birds, insects, animals. South America. 5 hours.",
      url: "https://archive.org/download/relaxingsounds/Rainforest%205h%20Bubbling%20River%20Falls(gentle)%2CBirds%2CInsects%2CAnimals-Daytime%2CSouth%20America.mp3"
    }
  ];

  const SOURCES_MECHANICAL = [
    {
      key: "starship_engine",
      name: "Starship Engine",
      color: COLORS.blue,
      desc: "Star Trek TNG warp engine ambient drone. Sleep in space. 24 hours.",
      url: "https://archive.org/download/AmbientEngineNoiseidlingFor24Hrs_614/AmbientEngineNoiseidlingFor24Hrs.mp3"
    }
  ];

  const ALL_SOURCES = [...SOURCES_CORE, ...SOURCES_BLENDS, ...SOURCES_BINAURAL, ...SOURCES_NATURE, ...SOURCES_MECHANICAL];
  
  // Load state from localStorage
  let favorites = JSON.parse(localStorage.getItem('colorNoiseFavorites') || '[]');
  let collapsedSections = JSON.parse(localStorage.getItem('colorNoiseCollapsed') || '{}');
  
  const player = document.getElementById("player");
  const nowPlayingTrack = document.getElementById("nowPlayingTrack");
  const favoritesSection = document.getElementById("favoritesSection");
  const favGrid = document.getElementById("favGrid");
  const timerDisplay = document.getElementById("timerDisplay");
  const toggleTimerBtn = document.getElementById("toggleTimer");
  const hoursEl = document.getElementById("hours");
  const minsEl = document.getElementById("mins");

  let currentKey = null;

  function saveFavorites() {
    localStorage.setItem('colorNoiseFavorites', JSON.stringify(favorites));
  }
  
  function saveCollapsed() {
    localStorage.setItem('colorNoiseCollapsed', JSON.stringify(collapsedSections));
  }

  function toggleFavorite(key) {
    const idx = favorites.indexOf(key);
    if (idx === -1) {
      favorites.push(key);
    } else {
      favorites.splice(idx, 1);
    }
    saveFavorites();
    renderAll();
  }

  function setActive(key) {
    document.querySelectorAll(".playBtn").forEach(b => {
      const isActive = b.dataset.key === key;
      b.classList.toggle("active", isActive);
      if (b.textContent !== "Soon") {
        b.textContent = isActive ? "Playing" : "Play";
      }
    });
    
    document.querySelectorAll(".favBtn").forEach(b => {
      b.classList.toggle("active", favorites.includes(b.dataset.key));
      b.textContent = favorites.includes(b.dataset.key) ? "â˜…" : "â˜†";
    });
    
    document.querySelectorAll(".favTile").forEach(t => {
      t.classList.toggle("active", t.dataset.key === key);
    });
  }

  function makeTile(item, compact = false) {
    const tile = document.createElement("div");
    tile.className = "tile" + (compact ? " compact-fav" : "");
    
    // Compact favorites: just a clickable button with dot + name
    if (compact) {
      tile.className = "favTile" + (currentKey === item.key ? " active" : "");
      tile.dataset.key = item.key;
      
      const dot = document.createElement("span");
      dot.className = "colorDot";
      dot.style.backgroundColor = item.color;
      dot.style.color = item.color;
      
      const name = document.createElement("span");
      name.className = "name";
      name.textContent = item.name;
      
      tile.appendChild(dot);
      tile.appendChild(name);
      
      // Add headphone icon for binaural/headphone-required tracks
      if (item.headphones) {
        const hpIcon = document.createElement("span");
        hpIcon.className = "headphoneIcon";
        hpIcon.textContent = "ðŸŽ§";
        tile.appendChild(hpIcon);
      }
      
      if (item.url) {
        tile.onclick = () => {
          if (currentKey === item.key && !player.paused) {
            player.pause();
            currentKey = null;
            nowPlayingTrack.textContent = "Select a sound";
            setActive(null);
            return;
          }

          currentKey = item.key;
          setActive(currentKey);
          nowPlayingTrack.textContent = "Loading...";

          player.src = item.url;
          player.load();
          
          const playPromise = player.play();
          if (playPromise !== undefined) {
            playPromise.then(() => {
              nowPlayingTrack.textContent = item.name;
            }).catch(e => {
              nowPlayingTrack.textContent = item.name + " (tap â–¶)";
            });
          }
        };
      }
      
      return tile;
    }

    // Full tile for main sections
    const top = document.createElement("div");
    top.className = "tileTop";

    const dot = document.createElement("span");
    dot.className = "colorDot";
    dot.style.backgroundColor = item.color;
    dot.style.color = item.color;

    const name = document.createElement("span");
    name.className = "name";
    name.textContent = item.name;

    const favBtn = document.createElement("span");
    favBtn.className = "favBtn" + (favorites.includes(item.key) ? " active" : "");
    favBtn.textContent = favorites.includes(item.key) ? "â˜…" : "â˜†";
    favBtn.dataset.key = item.key;
    favBtn.onclick = (e) => {
      e.stopPropagation();
      toggleFavorite(item.key);
    };

    const playBtn = document.createElement("div");
    playBtn.className = "playBtn" + (currentKey === item.key ? " active" : "");
    playBtn.dataset.key = item.key;
    
    if (item.url) {
      playBtn.textContent = currentKey === item.key ? "Playing" : "Play";
      playBtn.onclick = () => {
        if (!item.url) return;
        
        if (currentKey === item.key && !player.paused) {
          player.pause();
          currentKey = null;
          nowPlayingTrack.textContent = "Select a sound";
          setActive(null);
          return;
        }

        currentKey = item.key;
        setActive(currentKey);
        nowPlayingTrack.textContent = "Loading...";

        player.src = item.url;
        player.load();
        
        const playPromise = player.play();
        if (playPromise !== undefined) {
          playPromise.then(() => {
            nowPlayingTrack.textContent = item.name;
          }).catch(e => {
            nowPlayingTrack.textContent = item.name + " (tap â–¶)";
          });
        }
      };
    } else {
      playBtn.textContent = "Soon";
      playBtn.style.opacity = "0.5";
      playBtn.style.cursor = "default";
    }

    top.appendChild(dot);
    top.appendChild(name);
    top.appendChild(favBtn);
    top.appendChild(playBtn);

    tile.appendChild(top);
    
    const desc = document.createElement("div");
    desc.className = "desc";
    desc.textContent = item.desc;
    tile.appendChild(desc);
    
    return tile;
  }

  function renderSection(gridId, sources) {
    const grid = document.getElementById(gridId);
    grid.innerHTML = "";
    sources.forEach(s => grid.appendChild(makeTile(s)));
  }

  function renderAll() {
    // Render favorites (compact)
    favGrid.innerHTML = "";
    const favItems = ALL_SOURCES.filter(s => favorites.includes(s.key));
    
    if (favItems.length > 0) {
      favoritesSection.classList.remove("hidden");
      const favHeader = document.getElementById("favHeader");
      if (!collapsedSections.favorites) {
        favItems.forEach(s => favGrid.appendChild(makeTile(s, true)));
        favGrid.classList.remove("collapsed");
        favHeader.classList.remove("collapsed");
      } else {
        favGrid.classList.add("collapsed");
        favHeader.classList.add("collapsed");
      }
    } else {
      favoritesSection.classList.add("hidden");
    }

    // Render other sections
    renderSection("coreGrid", SOURCES_CORE);
    renderSection("blendsGrid", SOURCES_BLENDS);
    renderSection("binauralGrid", SOURCES_BINAURAL);
    renderSection("natureGrid", SOURCES_NATURE);
    renderSection("mechanicalGrid", SOURCES_MECHANICAL);
    
    // Apply collapsed state
    document.querySelectorAll(".sectionTitle[data-section]").forEach(header => {
      const section = header.dataset.section;
      const grid = header.nextElementSibling;
      if (collapsedSections[section]) {
        header.classList.add("collapsed");
        grid.classList.add("collapsed");
      } else {
        header.classList.remove("collapsed");
        grid.classList.remove("collapsed");
      }
    });
    
    setActive(currentKey);
    
    // Position favorites below header and adjust content padding
    updateLayout();
  }
  
  function updateLayout() {
    const header = document.querySelector('.fixedHeader');
    const content = document.querySelector('.content');
    const headerHeight = header.offsetHeight;
    
    if (favoritesSection.classList.contains('hidden')) {
      content.classList.remove('with-favorites');
      content.style.paddingTop = (headerHeight + 16) + 'px';
    } else {
      favoritesSection.style.top = headerHeight + 'px';
      content.classList.add('with-favorites');
      // Wait for favorites to render, then measure
      requestAnimationFrame(() => {
        const favHeight = favoritesSection.offsetHeight;
        content.style.paddingTop = (headerHeight + favHeight + 16) + 'px';
      });
    }
  }

  // Section collapse handlers
  document.querySelectorAll(".sectionTitle[data-section]").forEach(header => {
    header.onclick = () => {
      const section = header.dataset.section;
      collapsedSections[section] = !collapsedSections[section];
      saveCollapsed();
      renderAll();
    };
  });
  
  document.getElementById("favHeader").onclick = () => {
    collapsedSections.favorites = !collapsedSections.favorites;
    saveCollapsed();
    renderAll();
  };

  // Timer logic
  let setHours = 0;
  let setMins = 0;
  let endTime = null;
  let timerInterval = null;

  function formatTime(ms) {
    if (ms <= 0) return "0:00";
    const totalSec = Math.ceil(ms / 1000);
    const h = Math.floor(totalSec / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    const s = totalSec % 60;
    if (h > 0) {
      return h + ":" + String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
    }
    return m + ":" + String(s).padStart(2, "0");
  }

  function updateTimerDisplay() {
    if (!endTime) {
      timerDisplay.textContent = "0:00";
      timerDisplay.classList.add("off");
      return;
    }
    const remaining = endTime - Date.now();
    if (remaining <= 0) {
      stopTimer(true);
      return;
    }
    timerDisplay.textContent = formatTime(remaining);
    timerDisplay.classList.remove("off");
  }

  function startTimer() {
    const totalMs = (setHours * 3600 + setMins * 60) * 1000;
    if (totalMs <= 0) return;

    endTime = Date.now() + totalMs;
    toggleTimerBtn.textContent = "Stop";
    timerDisplay.classList.remove("off");
    
    updateTimerDisplay();
    timerInterval = setInterval(updateTimerDisplay, 1000);
  }

  function stopTimer(finished = false) {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
    
    if (finished) {
      player.pause();
      currentKey = null;
      nowPlayingTrack.textContent = "Timer finished";
      setActive(null);
    }
    
    endTime = null;
    toggleTimerBtn.textContent = "Start";
    timerDisplay.textContent = "0:00";
    timerDisplay.classList.add("off");
  }

  toggleTimerBtn.onclick = () => {
    if (endTime) {
      stopTimer(false);
    } else {
      startTimer();
    }
  };

  document.getElementById("hMinus").onclick = () => { 
    setHours = Math.max(0, setHours - 1); 
    hoursEl.textContent = setHours; 
  };
  document.getElementById("hPlus").onclick = () => { 
    setHours = Math.min(12, setHours + 1); 
    hoursEl.textContent = setHours; 
  };
  document.getElementById("mMinus").onclick = () => { 
    setMins = setMins - 15;
    if (setMins < 0) setMins = 45;
    minsEl.textContent = setMins; 
  };
  document.getElementById("mPlus").onclick = () => { 
    setMins = setMins + 15;
    if (setMins > 45) setMins = 0;
    minsEl.textContent = setMins; 
  };

  // Initial render
  renderAll();

  // Check sound engine status (Internet Archive)
  (async function checkArchiveStatus() {
    const statusEl = document.getElementById("sourceStatus");
    const testUrl = "https://archive.org/download/1-hour-brown-noise-and-flowing-water-320/1%20hour%20Brown%20Noise%20and%20Flowing%20River%20flac.mp3";
    
    try {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 8000);
      
      const response = await fetch(testUrl, { 
        method: "HEAD",
        mode: "no-cors",
        signal: controller.signal
      });
      
      clearTimeout(timeout);
      statusEl.innerHTML = '<span class="dot up"></span>Sound engine: operational';
    } catch (e) {
      statusEl.innerHTML = '<span class="dot down"></span>Sound engine: offline';
    }
  })();
})();
</script>
</body>
</html>
